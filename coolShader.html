
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Thumper</title>
        <script src="js/jquery-1.8.3.min.js"></script>
        <script src="js/underscore-min.js"></script>
        <script src="js/three.min.js"></script>
        <script src="js/EffectComposer.js"></script>
        <script src="js/RenderPass.js"></script>
        <script src="js/ShaderPass.js"></script>
        <script src="js/MaskPass.js"></script>
        <script src="js/CopyShader.js"></script>
    </head>
    <body>
        
        <p>Welcome to Thumper! </p>
        <p>Press a number to pick a song: </p>
        <p>1 - "The Modern Age" by the Strokes </p>
        <p>2 - "Helicopter" by Bloc Party </p>
        <p>3 - "Start Me Up" by the Rolling Stones </p>
        <p>4 - "Take Me Out" by Franz Ferdinand </p>
        <p>5 - "I Bet You Look Good on the Dancefloor" by Arctic Monkeys </p>
        <p> Chain together multiple hits to activate the combo multiplier! </p>
        <p> Press escape at any time to stop the song </p>
        
        <audio id='song1' src="sounds/themodernage.mp3"></audio>
        <audio id='song2' src="sounds/helicopter.mp3"></audio>
        <audio id='song3' src="sounds/startmeup.mp3"></audio>
        <audio id='song4' src="sounds/takemeout.mp3"></audio>
        <audio id='song5' src="sounds/ibylgotd.mp3"></audio>
        
        <!-----------All shader code goes here--------------->
        <script id='my-vertex-shader' type='x-shader/x-vertex'>
            varying vec3 vNormal;
            uniform float uTime;
            uniform float uBeatTime;
            uniform float uBeat;
            
            void main() {
                vNormal = normalMatrix * vec3(normal);
                gl_Position = projectionMatrix *
                modelViewMatrix *
                vec4((0.8 + 0.2 * uBeat) * position, 1.0);
            }
            </script>
        
        <script id='my-fragment-shader' type='x-shader/x-fragment'>
            varying vec3 vNormal;
            uniform float uTime;
            uniform float uBeatTime;
            uniform float uBeat;
            
            void main() {
                vec3 light = vec3(1.0, 2.0, 1.0);
                light = normalize(light);
                vec3 nvNormal = normalize(vNormal);
                float prod = max(0.0, dot(nvNormal, light));
                float tval = abs(cos(uBeatTime * 3.14159));
                gl_FragColor = vec4(tval, prod, 1, 1);
            }
            </script>
        
        <script id='trippy-vertex-shader' type='x-shader/x-vertex'>
            varying vec2 vUv;
            
            void main() {
                vUv = vec2(uv.x - 0.5, uv.y - 0.5); // center vUv
                gl_Position = projectionMatrix *
                modelViewMatrix *
                vec4(position, 1.0);
            }
            </script>
        
        <script id='trippy-fragment-shader' type='x-shader/x-fragment'>
            #define CURVE (20.0)
            #define SPEED (6.0)
            #define DENSITY (7.0)
            
            uniform float uTime;
            varying vec2 vUv;
            
            void main() {
                float ang = atan(vUv.y, vUv.x);
                float dist = length(vUv) * CURVE;
                float t = ang * DENSITY + uTime * SPEED;
                gl_FragColor = vec4(abs(sin(t + dist)), 0.0, 1.0, 1.0);
            }
            </script>
        
        <script id='my-postprocess-vertex-shader' type='x-shader/x-vertex'>
            varying vec2 vUv;
            
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
            </script>
        
        <script id='my-postprocess-fragment-shader' type='x-shader/x-fragment'>
            varying vec2 vUv;
            uniform sampler2D tDiffuse; // input texture
            
            void main() {
                vec4 color = texture2D( tDiffuse, vUv );
                gl_FragColor = vec4(color.r, color.g, color.b, 1.0);
            }
            </script>
        
        <script id='blur-postprocess-fragment-shader' type='x-shader/x-fragment'>
            varying vec2 vUv;
            uniform sampler2D tDiffuse; // input texture
            
            void main() {
                float dx = 1.0 / 800.0 * 3.0;
                float dy = 1.0 / 600.0 * 3.0;
                vec4 color0 = texture2D( tDiffuse, vec2(vUv.x, vUv.y) );
                vec4 color1 = texture2D( tDiffuse, vec2(vUv.x - dx, vUv.y) );
                vec4 color2 = texture2D( tDiffuse, vec2(vUv.x + dx, vUv.y) );
                vec4 color3 = texture2D( tDiffuse, vec2(vUv.x, vUv.y - dy) );
                vec4 color4 = texture2D( tDiffuse, vec2(vUv.x, vUv.y + dy) );
                gl_FragColor = (color0 + color1 + color2 + color3 + color4) * 0.2;
            }
            </script>
        <script>
            
            /**
             * Beat object
             * Helps convert between seconds and beats
             */
            var Beat = function(bpm) {
                this.bpm = bpm;
            };
            
            /**
             * Convert time to beatTime
             */
            Beat.prototype.toBeatTime = function(t) {
                var pulse;
                return pulse = t * this.bpm / 60.0;
                console.log(pulse);
            };
            
            /**
             * Convert time to beat value
             * Beat value is 0 to 1, hits 1 on the beat
             */
            Beat.prototype.toBeat = function(t) {
                return 1.0 - Math.abs(Math.sin(this.toBeatTime(t) * 3.14159));
            };
            
            /**
             * Game object
             * The highest level object representing entire game
             */
            var Game = function() {
            };
            
            
            /**
             * Initialize game state
             */
            Game.prototype.init = function() {
                var that = this;
                this.song = 0;
                this.score = 0;
                this.combo = 0;
                this.songName = 0;
                this.beat = new Beat(145);
                
                /* 
                 * Add text that updates 
                 */
                
                // Display score
                this.text2 = document.createElement('div');
                this.text2.style.position = 'absolute';
                this.text2.style.width = 400;
                this.text2.style.height = 400;
                this.text2.style.backgroundColor = "white";
                this.text2.style.top = 380 + 'px';
                this.text2.style.left = 375 + 'px';
                document.body.appendChild(this.text2);
                
                // Display the song name
                this.text3 = document.createElement('div');
                this.text3.style.position = 'absolute';
                this.text3.style.width = 400;
                this.text3.style.height = 400;
                this.text3.style.backgroundColor = "white";
                this.text3.style.top = 335 + 'px';
                this.text3.style.left = 375 + 'px';
                document.body.appendChild(this.text3);
                
                // Display the combo count
                this.text4 = document.createElement('div');
                this.text4.style.position = 'absolute';
                this.text4.style.width = 400;
                this.text4.style.height = 400;
                this.text4.style.backgroundColor = "white";
                this.text4.style.top = 430 + 'px';
                this.text4.style.left = 375 + 'px';
                document.body.appendChild(this.text4);
                
                this.camera = new THREE.PerspectiveCamera(75, 4.0/3.0, 1, 10000);
                this.camera.position.y = -275;
                this.camera.position.z = 600;
                
                var vertexShaderText = $('#my-vertex-shader').text();
                var fragmentShaderText = $('#my-fragment-shader').text();
                var trippyVertexShaderText = $('#trippy-vertex-shader').text();
                var trippyFragmentShaderText = $('#trippy-fragment-shader').text();
                var blurFragmentShaderText = $('#blur-postprocess-fragment-shader').text();
                
                /* 
                 * Add the Three.js objects seen in the game 
                 */
                
                // Initialize the material used for the speakers
                this.speakerMaterial = new THREE.ShaderMaterial({
                                                           uniforms: {
                                                           'uTime': { type: 'f', value: 0.0 },
                                                           'uBeatTime': { type: 'f', value: 0.0 },
                                                           'uBeat': { type: 'f', value: 0.0 }
                                                           },
                                                           vertexShader: vertexShaderText,
                                                           fragmentShader: fragmentShaderText
                                                           });
                this.scene = new THREE.Scene();
                this.speaker1 = new THREE.Mesh(
                                           new THREE.CubeGeometry(100, 200, 100),
                                           this.speakerMaterial);
                this.speaker1.position.x = -300;
                this.speaker1.position.y = -300;
                this.scene.add(this.speaker1);
                
                this.speaker2 = new THREE.Mesh(
                                               new THREE.CubeGeometry(100, 200, 100),
                                               this.speakerMaterial);
                this.speaker2.position.x = 300;
                this.speaker2.position.y = -300;
                this.scene.add(this.speaker2);
                
                this.posterMaterial = new THREE.ShaderMaterial({
                                                           uniforms: {
                                                           'uTime': { type: 'f', value: 0.0 },
                                                           },
                                                           vertexShader: trippyVertexShaderText,
                                                           fragmentShader: trippyFragmentShaderText
                                                           });
                this.poster = new THREE.Mesh(
                                             new THREE.PlaneGeometry(600, 600),
                                             this.posterMaterial);
                this.poster.position.y = -110;
                this.poster.position.z = -100;
                this.scene.add(this.poster);
                
                this.sphereMaterial = new THREE.ShaderMaterial({
                                                               uniforms: {
                                                               'uTime': { type: 'f', value: 0.0 },
                                                               'uBeatTime': { type: 'f', value: 0.0 },
                                                               'uBeat': { type: 'f', value: 0.0 }
                                                               },
                                                               vertexShader: vertexShaderText,
                                                               fragmentShader: blurFragmentShaderText
                                                               });
                
                this.sphere1 = new THREE.Mesh(
                                           new THREE.SphereGeometry(100, 6, 6),
                                           this.speakerMaterial);
                this.sphere1.position.x = 400;
                this.sphere1.position.y = 250;
                this.sphere2 = new THREE.Mesh(
                                            new THREE.SphereGeometry(100, 6, 6),
                                            this.speakerMaterial);
                this.sphere2.position.x = 200;
                this.sphere2.position.y = 250;
                this.sphere3 = new THREE.Mesh(
                                              new THREE.SphereGeometry(100, 6, 6),
                                              this.speakerMaterial);
                this.sphere3.position.x = 0;
                this.sphere3.position.y = 250;
                this.sphere4 = new THREE.Mesh(
                                              new THREE.SphereGeometry(100, 6, 6),
                                              this.speakerMaterial);
                this.sphere4.position.x = -200;
                this.sphere4.position.y = 250;
                this.sphere5 = new THREE.Mesh(
                                              new THREE.SphereGeometry(100, 6, 6),
                                              this.speakerMaterial);
                this.sphere5.position.x = -400;
                this.sphere5.position.y = 250;
                this.scene.add(this.sphere1);
                this.scene.add(this.sphere2);
                this.scene.add(this.sphere3);
                this.scene.add(this.sphere4);
                this.scene.add(this.sphere5);
                
                // Add the model human figure
                this.figure = null;
                var jsonLoader = new THREE.JSONLoader();
                jsonLoader.load('figure.js', function(geometry) {
                                that.figure = new THREE.Mesh(geometry, that.myMaterial);
                                that.figure.scale.set(40, 40, 40);
                                that.figure.position.x = 0;
                                that.figure.position.y = -450;
                                that.scene.add(that.figure);
                                });
                
                // Add the skybox
                this.skyBoxGeometry = new THREE.CubeGeometry( 10000, 10000, 10000 );
                this.skyBoxMaterial = new THREE.MeshBasicMaterial( { color: 0x9999ff, side: THREE.BackSide } );
                this.skyBox = new THREE.Mesh( this.skyBoxGeometry, this.skyBoxMaterial );
                this.scene.add(this.skyBox);
                this.scene.fog = new THREE.FogExp2( 0x9999ff, 0.00025 );
                
                // Render the image
                this.renderer = new THREE.WebGLRenderer({antialias: true});
                this.renderer.setSize(800, 600);
                this.renderer.setClearColor(0xeeeeee, 1.0);
                document.body.appendChild(this.renderer.domElement);
                
                /* 
                 * Setup keyboard events  
                 */
                
                this.keys = {};
                $('body').keydown(function(e) {
                                  console.log('keydown ' + e.which);
                                  if (e.which) {
                                  if (that.keys[e.which] !== 'triggered') {
                                  that.keys[e.which] = true;
                                  }
                                  }
                                  console.log(that.keys);
                                  });
                $('body').keyup(function(e) {
                                console.log('keyup ' + e.which);
                                if (e.which) {
                                that.keys[e.which] = false;
                                }
                                console.log(that.keys);
                                });
            
                
                this.composer = new THREE.EffectComposer(this.renderer);
                this.composer.addPass(new THREE.RenderPass(this.scene, this.camera));
                
                var MyEffectShader = {
                    uniforms: { 'tDiffuse': { type: 't', value: null }},
                    vertexShader: $('#my-postprocess-vertex-shader').text(),
                    fragmentShader: $('#my-postprocess-fragment-shader').text()
                };
                var effect = new THREE.ShaderPass(MyEffectShader);
                effect.renderToScreen = true;
                this.composer.addPass(effect);
            };
            
            
            
            
            /**
             * Render game view for time t
             */
            Game.prototype.render = function(t) {
                this.speakerMaterial.uniforms['uTime'].value = t;
                this.speakerMaterial.uniforms['uBeatTime'].value = this.beat.toBeatTime(t);
                this.speakerMaterial.uniforms['uBeat'].value = this.beat.toBeat(t);
                this.posterMaterial.uniforms['uTime'].value = t;
                this.sphere1.rotation.x += 0.01;
                this.sphere1.rotation.y += 0.007;
                this.sphere2.rotation.x += 0.01;
                this.sphere2.rotation.y += 0.007;
                this.camera.lookAt(this.scene.position);
                this.composer.render();
            };
            
            Game.prototype.handleInput = function() {
                
                /* 
                 * Song selection buttons 
                 */
                
                if (this.keys[49]){
                    // "The Modern Age" by the Strokes
                    this.song = $('#song1')[0];
                    this.songName = "The Modern Age";
                    this.text3.innerHTML = "Song name: " + this.songName;
                    this.song.play();
                    this.beat = new Beat(146);
                }
                if (this.keys[50]){
                    console.log("Helicopter");
                    this.song = $('#song2')[0];
                    this.songName = "Helicopter";
                    this.text3.innerHTML = "Song name: " + this.songName;
                    this.song.play();
                    this.beat = new Beat(85);
                }
                if(this.keys[51]){
                    console.log("Start Me Up");
                    this.song = $('#song3')[0];
                    this.songName = "Start Me Up";
                    this.text3.innerHTML = "Song name: " + this.songName;
                    this.song.play();
                    this.beat = new Beat(122);
                }
                if(this.keys[52]){
                    console.log("Take Me Out");
                    this.song = $('#song4')[0];
                    this.songName = "Take Me Out";
                    this.text3.innerHTML = "Song name: " + this.songName;
                    this.song.play();
                    this.beat = new Beat(105);
                }
                if(this.keys[53]){
                    console.log("I Bet You Look Good on the Dancefloor");
                    this.song = $('#song5')[0];
                    this.songName = "I Bet You Look Good on the Dancefloor";
                    this.text3.innerHTML = "Song name: " + this.songName;
                    this.song.play();
                    this.beat = new Beat(103);
                }
                if(this.keys[27]){
                    this.song.pause();
                    console.log("Final score for " + this.songName + " is: " + this.score);
                }
                
                if (this.keys[32] === true) {
                    this.keys[32] = 'triggered';
                    var pulse = this.speakerMaterial.uniforms['uBeat'].value;
                    this.text2.innerHTML = "Score = " + this.score;
                    this.text4.innerHTML = "Combo = " + this.combo;
                    
                    /**
                     * Score threshold
                     */
                    
                    // Marvelous!
                    if (pulse >= 0.951 && pulse <= 0.9999999){
                        this.combo += 1;
                        this.score += 5;
                        if (this.combo >= 5) {
                            this.score += 10;
                        }
                        console.log("Marvelous!");
                        console.log(this.score);
                        console.log(this.combo);
                    }
                    // Perfect
                    else if (pulse >= 0.901 && pulse <= 0.95) {
                        this.combo += 1;
                        this.score += 4;
                        if (this.combo >= 5) {
                            this.score += 8;
                        }
                        console.log("Perfect!");
                        console.log(this.score);
                        console.log(this.combo);
                    }
                    // Good
                    else if (pulse >= 0.701 && pulse <= .90){
                        this.combo += 1;
                        this.score += 2;
                        if (this.combo >= 5) {
                            this.score += 4;
                        }
                        console.log("Good!");
                        console.log(this.score);
                        console.log(this.combo);
                    }
                    // O.K
                    else if (pulse >= 0.601 && pulse <= .70){
                        this.combo += 1;
                        this.score += 1;
                        if (this.combo >= 5) {
                            this.score += 2;
                        }
                        console.log("O.K!");
                        console.log(this.score);
                        console.log(this.combo);
                    }
                    // MISS
                    else if (pulse <= .60){
                        this.combo = 0;
                        this.score += 0;
                        console.log("MISS");
                        console.log(this.score);
                        console.log(this.combo);
                    }
                }
            }
            
            /**
             * Start main game loop
             */
            Game.prototype.start = function() {
                var that = this;
                var time0 = new Date().getTime(); // milliseconds since 1970
                var loop = function() {
                    var time = new Date().getTime();
                    that.render((time - time0) * 0.001);
                    requestAnimationFrame(loop, that.renderer.domElement);
                    // Respond to user input
                    that.handleInput();
                };
                loop();  
            };
            
            //// 
            
            var game = new Game();
            game.init();
            game.start();
            
            </script>
        
    </body>
</html>

