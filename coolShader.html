
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Thumper</title>
        <script src="js/jquery-1.8.3.min.js"></script>
        <script src="js/underscore-min.js"></script>
        <script src="js/three.min.js"></script>
        <script src="js/EffectComposer.js"></script>
        <script src="js/RenderPass.js"></script>
        <script src="js/ShaderPass.js"></script>
        <script src="js/MaskPass.js"></script>
        <script src="js/CopyShader.js"></script>
    </head>
    <body>
        
        <p>Javascript game using shaders. </p>
        
        <script id='my-vertex-shader' type='x-shader/x-vertex'>
            varying vec3 vNormal;
            uniform float uTime;
            uniform float uBeatTime;
            uniform float uBeat;
            
            void main() {
                vNormal = normalMatrix * vec3(normal);
                gl_Position = projectionMatrix *
                modelViewMatrix *
                vec4((0.8 + 0.2 * uBeat) * position, 1.0);
            }
            </script>
        
        <script id='my-fragment-shader' type='x-shader/x-fragment'>
            varying vec3 vNormal;
            uniform float uTime;
            uniform float uBeatTime;
            uniform float uBeat;
            
            void main() {
                vec3 light = vec3(1.0, 2.0, 1.0);
                light = normalize(light);
                vec3 nvNormal = normalize(vNormal);
                float prod = max(0.0, dot(nvNormal, light));
                float tval = abs(cos(uBeatTime * 3.14159));
                gl_FragColor = vec4(tval, prod, 1, 1);
            }
            </script>
        
        <script id='trippy-vertex-shader' type='x-shader/x-vertex'>
            varying vec2 vUv;
            
            void main() {
                vUv = vec2(uv.x - 0.5, uv.y - 0.5); // center vUv
                gl_Position = projectionMatrix *
                modelViewMatrix *
                vec4(position, 1.0);
            }
            </script>
        
        <script id='trippy-fragment-shader' type='x-shader/x-fragment'>
            #define CURVE (20.0)
            #define SPEED (6.0)
            #define DENSITY (2.0)
            
            uniform float uTime;
            varying vec2 vUv;
            
            void main() {
                float ang = atan(vUv.y, vUv.x);
                float dist = length(vUv) * CURVE;
                float t = ang * DENSITY + uTime * SPEED;
                gl_FragColor = vec4(abs(sin(t + dist)), 0.0, 1.0, 1.0);
            }
            </script>
        
        <script id='my-postprocess-vertex-shader' type='x-shader/x-vertex'>
            varying vec2 vUv;
            
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
            </script>
        
        <script id='my-postprocess-fragment-shader' type='x-shader/x-fragment'>
            varying vec2 vUv;
            uniform sampler2D tDiffuse; // input texture
            
            void main() {
                vec4 color = texture2D( tDiffuse, vUv );
                gl_FragColor = vec4(color.r, color.g, color.b, 1.0);
            }
            </script>
        
        <script>
            
            /**
             * Beat object
             * Helps convert between seconds and beats
             */
            var Beat = function(bpm) {
                this.bpm = bpm;
            };
            
            /**
             * Convert time to beatTime
             */
            Beat.prototype.toBeatTime = function(t) {
                return t * this.bpm / 60.0;
            };
            
            /**
             * Convert time to beat value
             * Beat value is 0 to 1, hits 1 on the beat
             */
            Beat.prototype.toBeat = function(t) {
                return 1.0 - Math.abs(Math.sin(this.toBeatTime(t) * 3.14159));
            };
            
            /**
             * Game object
             * The highest level object representing entire game
             */
            var Game = function() {
            };
            
            /**
             * Initialize game state
             */
            Game.prototype.init = function() {
                this.beat = new Beat(120.0);
                
                this.camera = new THREE.PerspectiveCamera(75, 4.0/3.0, 1, 10000);
                this.camera.position.y = -200;
                this.camera.position.z = 500;
                
                var vertexShaderText = $('#my-vertex-shader').text();
                var fragmentShaderText = $('#my-fragment-shader').text();
                var trippyVertexShaderText = $('#trippy-vertex-shader').text();
                var trippyFragmentShaderText = $('#trippy-fragment-shader').text();
                
                this.speakerMaterial = new THREE.ShaderMaterial({
                                                           uniforms: {
                                                           'uTime': { type: 'f', value: 0.0 },
                                                           'uBeatTime': { type: 'f', value: 0.0 },
                                                           'uBeat': { type: 'f', value: 0.0 }
                                                           },
                                                           vertexShader: vertexShaderText,
                                                           fragmentShader: fragmentShaderText
                                                           });
                this.scene = new THREE.Scene();
                this.speaker1 = new THREE.Mesh(
                                           new THREE.CubeGeometry(100, 200, 100),
                                           this.speakerMaterial);
                this.speaker1.position.x = -300;
                this.speaker1.position.y = -100;
                this.scene.add(this.speaker1);
                
                this.speaker2 = new THREE.Mesh(
                                               new THREE.CubeGeometry(100, 200, 100),
                                               this.speakerMaterial);
                this.speaker2.position.x = 300;
                this.speaker2.position.y = -100;
                this.scene.add(this.speaker2);
                
                this.posterMaterial = new THREE.ShaderMaterial({
                                                           uniforms: {
                                                           'uTime': { type: 'f', value: 0.0 },
                                                           },
                                                           vertexShader: trippyVertexShaderText,
                                                           fragmentShader: trippyFragmentShaderText
                                                           });
                this.poster = new THREE.Mesh(
                                             new THREE.PlaneGeometry(600, 600),
                                             this.posterMaterial);
                this.poster.position.y = 110;
                this.poster.position.z = -100;
                this.scene.add(this.poster);
                
                this.renderer = new THREE.WebGLRenderer({antialias: true});
                this.renderer.setSize(800, 600);
                this.renderer.setClearColor(0xeeeeee, 1.0);
                document.body.appendChild(this.renderer.domElement);
                
                this.composer = new THREE.EffectComposer(this.renderer);
                this.composer.addPass(new THREE.RenderPass(this.scene, this.camera));
                
                var MyEffectShader = {
                    uniforms: { 'tDiffuse': { type: 't', value: null }},
                    vertexShader: $('#my-postprocess-vertex-shader').text(),
                    fragmentShader: $('#my-postprocess-fragment-shader').text()
                };
                var effect = new THREE.ShaderPass(MyEffectShader);
                effect.renderToScreen = true;
                this.composer.addPass(effect);
            };
            
            /**
             * Render game view for time t
             */
            Game.prototype.render = function(t) {
                this.speakerMaterial.uniforms['uTime'].value = t;
                this.speakerMaterial.uniforms['uBeatTime'].value = this.beat.toBeatTime(t);
                this.speakerMaterial.uniforms['uBeat'].value = this.beat.toBeat(t);
                this.posterMaterial.uniforms['uTime'].value = t;
                //this.cube.rotation.x += 0.01;
                //this.cube.rotation.y += 0.007;
                this.camera.lookAt(this.scene.position);
                this.composer.render();
            };
            
            /**
             * Start main game loop
             */
            Game.prototype.start = function() {
                var that = this;
                var time0 = new Date().getTime(); // milliseconds since 1970
                var loop = function() {
                    var time = new Date().getTime();
                    that.render((time - time0) * 0.001);
                    requestAnimationFrame(loop, that.renderer.domElement);
                };
                loop();  
            };
            
            //// 
            
            var game = new Game();
            game.init();
            game.start();
            
            </script>
        
    </body>
</html>

